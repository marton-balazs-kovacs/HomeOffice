---
title: "HomeOffice_Main_Analysis"
author: "Marton Kovacs"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: html_document
---

# Install packages

```{r, message = FALSE, warning = FALSE}
library(tidyverse)
```

# Source R scripts

```{r}
r_scripts <- list.files("R/", full.names = TRUE)
walk(r_scripts, source)
```

# Importing data

```{r, message = FALSE}
processed <- read_tsv("Data/Main/Processed/HomeOffice_Main_Processed_data.tsv")
```

# Descriptives
## Number of respondents

There are `r nrow(processed)` individual responses used for the analysis.

## Median time of responding to the survey

```{r}
processed %>% 
  mutate(duration_in_seconds = as.integer(duration_in_seconds)) %>% 
  summarise(median_resp = median(duration_in_seconds) / 60)
```

## Gender distribution

```{r}
percent_by_group(processed, gender)
apa_barplot(processed, gender)
```

## Disciplines

```{r}
percent_by_group(processed, area_of_research)
apa_barplot(processed, area_of_research) +
  coord_flip()
```

## Position

```{r}
percent_by_group(processed, position)
apa_barplot(processed, position) +
  coord_flip()
```

## Type of workplace

```{r}
percent_by_group(processed, wokrplace_type)
apa_barplot(processed, wokrplace_type) +
  coord_flip()
```

## Is it possible to collect data remotely

```{r}
percent_by_group(processed, data_coll_remote)
apa_barplot(processed, data_coll_remote)
```

## Age group

```{r}
percent_by_group(processed, age)
apa_barplot(processed, age)
```

## Educational duties at work


```{r}
percent_by_group(processed, edu_duties)
apa_barplot(processed, edu_duties)
```

## Reasearch require intensive teamwork

```{r}
percent_by_group(processed, team_work)
apa_barplot(processed, team_work)
```

## Office setup at home

```{r}
percent_by_group(processed, office_setup)
apa_barplot(processed, office_setup)
```

## Living situation

```{r}
percent_by_group(processed, living_sit)
apa_barplot(processed, living_sit) +
  coord_flip()
```

## Partner working from home during the pandemic

```{r}
percent_by_group(processed, partner_work)
apa_barplot(processed, partner_work)
```

## How far is the office from home

```{r}
percent_by_group(processed, work_home_dist)
apa_barplot(processed, work_home_dist)
```

## Number of children

```{r}
percent_by_group(processed, number_of_children)
apa_barplot(processed, number_of_children)
```

## Homeschooling during pandemic

```{r}
percent_by_group(processed, homeschool)
apa_barplot(processed, homeschool)
```

## Help with children during pandemic

```{r}
percent_by_group(processed, childcare_help)
apa_barplot(processed, childcare_help)
```

# Percentage of working more from home during the pandemic

```{r}
percent_by_group(processed, working_home_time)
```

`r filter(processed, working_home_time == "Yes") %>% count()`% of the surveyed researchers worked more from home during the pandemic lockdown.

# Efficiency of remore working
## During the lockdown

```{r}
processed %>% 
  distinct(now_before_eff)

now_before_eff <-
  processed %>% 
  filter(working_home_time == "Yes") %>% 
  percent_by_group(now_before_eff)

now_before_eff
```

The number of trials where the efficiency rating is missing is `r filter(processed, is.na(now_before_eff)) %>% count()`. It is because this question was not shown to those who said that they are not working more from home. 

`r filter(now_before_eff, now_before_eff == "less efficient") %>% pull(prop)`% of the surveyed scientists who worked more from home during the coronavirus lockdown found that due to working more from home their research became, in general, less efficient, `r filter(now_before_eff, now_before_eff == "more efficient") %>% pull(prop)`% found it more efficient, and `r filter(now_before_eff, now_before_eff == "similarly efficient") %>% pull(prop)`% found no difference compared to working before the lockdown. (only from those working from home).

```{r}
eff_during_plot_data <-
  processed %>%
  filter(working_home_time == "Yes") %>%
  mutate(now_before_eff = forcats::fct_relevel(now_before_eff, c("less efficient", "similarly efficient", "more efficient"))) %>%
  percent_by_group(now_before_eff)

y_max_during <- round_any(max(eff_during_plot_data$prop), 0.1, f = ceiling)

eff_during_plot_data %>%
  ggplot() +
  aes(x = now_before_eff,
      y = prop) +
  geom_bar(stat = "identity") +
  scale_y_continuous(expand = c(0, 0),
                     limits = c(0, y_max_during)) +
  labs(x = "Change in the efficiency of the research work",
        y = "Percentage of responses") +
  papaja::theme_apa()
```

## After the lockdown

```{r}
processed %>% 
  distinct(now_later_eff)

now_later_eff <-
  processed %>% 
  filter(prior_home_prop_1 != 100) %>%
  percent_by_group(now_later_eff)

now_later_eff
```

`r filter(now_later_eff, now_later_eff == "less efficient") %>% pull(prop)`% of the surveyed scientists assume that working more from home after the coronavirus lockdown could make their research, in general, less efficient, `r filter(now_later_eff, now_later_eff == "more efficient") %>% pull(prop)`% found it more efficient, and `r filter(now_later_eff, now_later_eff == "similarly efficient") %>% pull(prop)`% found no difference compared to the time before the lockdown. (excluding 100% home workers).

```{r}
eff_after_plot_data <-
  processed %>%
  filter(prior_home_prop_1 != 100) %>%
  mutate(now_later_eff = forcats::fct_relevel(now_later_eff, c("less efficient", "similarly efficient", "more efficient"))) %>%
  percent_by_group(now_later_eff)

y_max_during <- round_any(max(eff_after_plot_data$prop), 0.1, f = ceiling)

eff_after_plot_data %>%
  ggplot() +
  aes(x = now_later_eff,
      y = prop) +
  geom_bar(stat = "identity") +
  scale_y_continuous(expand = c(0, 0),
                     limits = c(0, y_max_during)) +
  labs(x = "Change in the efficiency of the research work",
        y = "Percentage of responses") +
  papaja::theme_apa()
```

## Investigating aspects of research

We calculate the means and SDs of each aspects ratings. Aspects with higher rating than 4 indicates that it is better to do the task from the lab. Ratings with lower mean rating than 4 means that it is better to do the given action from home.

```{r, message = FALSE}
aspects <- 
    processed %>%
    select(participant_id, contains("home_office_aspect")) %>%
    gather(key = "aspect", value = "rating", -participant_id) %>% 
    mutate(aspect = case_when(aspect == "home_office_aspect_1" ~ "Optimally organizing my time",
                              aspect == "home_office_aspect_2" ~ "Optimally organizing my tasks",
                              aspect == "home_office_aspect_3" ~ "Keeping focused on my tasks",
                              aspect == "home_office_aspect_4" ~ "Keeping in touch with my team",
                              aspect == "home_office_aspect_5" ~ "Sharing thoughts with colleagues",
                              aspect == "home_office_aspect_6" ~ "Getting support from colleagues",
                              aspect == "home_office_aspect_7" ~ "Working on my manuscript",
                              aspect == "home_office_aspect_8" ~ "Analyzing my data",
                              aspect == "home_office_aspect_9" ~ "Reading the literature",
                              aspect == "home_office_aspect_10" ~ "Collecting data",
                              aspect == "home_office_aspect_11" ~ "Having the infrastructure\n(IT, books, instruments)",
                              aspect == "home_office_aspect_12" ~ "Maintaining emotional balance",
                              aspect == "home_office_aspect_13" ~ "Maintaining work-life balance",
                              aspect == "home_office_aspect_14" ~ "Keeping good relationship\nwith colleagues",
                              aspect == "home_office_aspect_15" ~ "Developing new skills")) %>% 
  group_by(aspect) %>% 
  summarise(mean = mean(rating, na.rm = TRUE),
            sd = sd(rating, na.rm = TRUE)) %>% 
  mutate(better_home = case_when(mean > 4 ~ 0L,
                                 mean < 4 ~ 1L,
                                 mean == 4 ~ NA_integer_)) %>% 
  arrange(better_home, mean)
```

```{r}
aspects %>%
  ggplot() +
  aes(x = fct_reorder(aspect, mean),
      y = mean) +
  geom_bar(stat = "identity") +
  scale_y_continuous(
    expand = c(0, 0.4),
    breaks = c(1, 2, 3, 4, 5, 6, 7),
    labels = c("1\nAt home", "2", "3", "4", "5", "6", "7\nIn the office")) +
  coord_flip(ylim = c(1, 7)) +
  geom_hline(yintercept = 4, linetype = "dashed", color = "#828282", size = 1) +
  labs(x = "Aspects",
        y = "Mean rating") +
  papaja::theme_apa()
```

### Main advantages of working from home

The three lowest-rated advantages of working from home

```{r}
aspects %>% 
  filter(better_home == 1L) %>% 
  slice_min(mean, n = 3)
```

### Main advantages of working in the lab

The three highest-rated advantages of working from the lab

```{r}
aspects %>% 
  filter(better_home == 0L) %>% 
  slice_max(mean, n = 3)
```

## How much did researchers work from home before the pandemic?

The distribution of percentages of working from your home time before the pandemic.

```{r}
percentage_plot_data <-
    processed %>%
    select(participant_id,
           prior_home_prop_1,
           future_home_prop_1) %>%
    gather(key = "time", value = "percent", -participant_id) %>%
    mutate(time = case_when(time == "prior_home_prop_1" ~ "Prior to pandemic",
                            time == "future_home_prop_1" ~ "Ideal"),
           time = factor(time, c("Prior to pandemic", "Ideal")))

percentage_plot_data %>%
  filter(time == "Prior to pandemic") %>% 
  ggplot() +
  aes(x = percent) +
  geom_density(alpha = 0.6, size = 0.8) +
  scale_y_continuous(expand = c(0.01, 0),
                     breaks = scales::pretty_breaks()) +
  scale_x_continuous(expand = c(0, 0),
                     breaks = seq(0, 100, 10),
                     labels = seq(0, 100, 10)) +
  labs(x = "Percentage of worktime working from home prior to pandemic",
       y = "Density") +
  papaja::theme_apa()
```

## How much would researchers work from home after the pandemic?

The distribution of percentages of ideal working from home time after the pandemic.

```{r}
percentage_plot_data %>%
  filter(time == "Ideal") %>% 
  ggplot() +
  aes(x = percent) +
  geom_density(alpha = 0.6, size = 0.8) +
  scale_y_continuous(expand = c(0.01, 0),
                     breaks = scales::pretty_breaks()) +
  scale_x_continuous(expand = c(0, 0),
                     breaks = seq(0, 100, 10),
                     labels = seq(0, 100, 10)) +
  labs(x = "Percentage of worktime working from home",
       y = "Density") +
  papaja::theme_apa()
```

Prior and ideal percentages of working from home on the smae figure.

```{r}
percentage_plot_data %>%
  ggplot() +
  aes(x = percent,
      color = time) +
  geom_density(alpha = 0.6, size = 0.8) +
  scale_y_continuous(expand = c(0.01, 0),
                     breaks = scales::pretty_breaks()) +
  scale_x_continuous(expand = c(0, 0),
                     breaks = seq(0, 100, 10),
                     labels = seq(0, 100, 10)) +
  scale_fill_manual(values = c('#000000', '#D3D3D3')) +
  scale_color_manual(values=c('#000000', '#D3D3D3'))+
  labs(x = "Percentage of worktime working from home",
       y = "Density",
       color = "Time") +
  papaja::theme_apa()
```

## Would it be possible to work more from home in the future?

See the distinct values of the difference between the ideal percentage of working more from the future and the prior percentage. If the difference is negative the respondent wants to work less from home in the future, if it is positive the respondents wants to work more from home in the future.

```{r}
processed %>% 
  distinct(future_prior_diff) %>% 
  arrange(future_prior_diff) %>% 
  knitr::kable()
```

Showing a descriptive comparison.

```{r}
processed %>% 
  mutate(more_from_home = case_when(future_prior_diff > 0 ~ "Respondent wants to work more from home",
                                    future_prior_diff < 0 ~ "Respondent wants to work less from home",
                                    future_prior_diff == 0 ~ "Respondent working the ideal amount of time from home")) %>% 
  count(more_from_home) %>%
  mutate(N = sum(n),
         prop = n / N * 100) %>% 
  arrange(n)
```

Number of respondents who worked 100% from home before the pandemic.

```{r}
processed %>% 
  filter(prior_home_prop_1 == 100) %>% 
  count()
```

Taken all their other duties (education, administration, etc.) and provided circumstances at home (infrastructure, level of disturbance) of researchers think that it would be possible to work more from home in the future. (excluding 100% home workers, including only wishing to work more from home, OF those who find working from home more efficient)

```{r}
processed %>% 
  filter(prior_home_prop_1 != 100,
         future_prior_diff > 0,
         now_later_eff == "more efficient") %>% 
  count(feasible) %>% 
  mutate(N = sum(n),
         prop = n / N * 100)
```

## Additional analyses

Additional descriptive results will be provided for the interested subgroups. Our interested subgroups will be primarily those relevant to the following questions: 

### Are people living with children more or less efficient when working from home?

```{r}
processed %>% distinct(living_sit)

living_sit_include <- c("Living with partner and non-adult child(ren)", "Single-parent with non-adult child(ren)")
```

Number of kids in this subsample.

```{r}
processed %>% 
  filter(living_sit %in% living_sit_include) %>% 
  count(number_of_children)
```

```{r}
processed %>% 
  filter(living_sit %in% living_sit_include,
         !is.na(now_before_eff)) %>% 
  percent_by_group(now_before_eff)
```

### What circumstances make a researcher with children more or less efficient in working from home during and after the lockdown?

```{r}
# Variables that we will use to create the subgroups
subvars <- c("position", "area_of_research", "wokrplace_type", "data_coll_remote", "gender", "age", "edu_duties", "team_work", "partner_work")

# Subset of data: respondents living with kids
with_child <-
  processed %>% 
  filter(living_sit %in% living_sit_include,
         prior_home_prop_1 != 100)

# Create dataframe for storing the subgroup selection and efficiency ratings
sub_selection <-
  tibble(
    subvars = syms(subvars)
  )

# Create function to count the number of respondents on each level of the subgroup
# and exclude levels where the level has less than 30 respondent in it
filter_subgroup_levels <- function(subvar_name) {
  subvar_name <- dplyr::enquo(subvar_name)
  with_child %>%
    filter(!is.na(!!subvar_name)) %>% 
    count(!!subvar_name) %>% 
    filter(n > 20)
}

# Example of the subgroup efficiency output
with_child %>% 
  filter(position == "assistant professor") %>% 
  percent_by_group(now_later_eff)

# Function to calculate efficiency proportions for subgroup
efficiency_subgroups_levels <- function(subvar_name, subgroup_name) {
  subvar_name <- dplyr::enquo(subvar_name)
  map(subgroup_name,
      ~ with_child %>% 
        filter(!!subvar_name == .x) %>% 
        percent_by_group(now_later_eff)) %>% 
    set_names(subgroup_name)
}

# Filtering the subgroups and calculating efficiency proportions for each subgroup
sub_selection <-
  sub_selection %>% 
  mutate(subgroup_desc = purrr::map(subvars, filter_subgroup_levels),
         subgroup_vec = purrr::map2(subvars, subgroup_desc, ~ pull(.y, .x)),
         subgroup_eff_desc = purrr::map2(subvars, subgroup_vec, efficiency_subgroups_levels),
         subgroup_eff_desc = set_names(subgroup_eff_desc, map(subvars, ~rlang::as_name(.x))))

# Simplifying the results to a df
sub_selection_df <- 
  sub_selection %>% 
  select(subgroup_eff_desc, subvars) %>%
  unnest_longer(subgroup_eff_desc) %>% 
  unnest(subgroup_eff_desc) %>% 
  rename(subgroups = subgroup_eff_desc_id)

# Get levels less efficiency proportions
sub_less_eff <-
  sub_selection_df %>% 
  filter(now_later_eff == "less efficient") %>% 
  arrange(desc(prop))

# Get levels more efficiency proportions
sub_more_eff <-
  sub_selection_df %>% 
  filter(now_later_eff == "more efficient") %>% 
  arrange(desc(prop))

# Get levels similarly efficiency proportions
sub_similarly_eff <-
  sub_selection_df %>% 
  filter(now_later_eff == "similarly efficient") %>% 
  arrange(desc(prop))
```

#### Print less efficient subgroups by proportion

```{r}
sub_less_eff %>% 
  knitr::kable()
```

#### Print less efficient subgroups by proportion

```{r}
sub_more_eff %>% 
  knitr::kable()
```

#### Print similarly efficient subgroups by proportion

```{r}
sub_similarly_eff %>% 
  knitr::kable()
```

### Which subgroup would benefit the most/less from working more from home? [interested factors: seniority, data collection method]

We need to talk about this. We decide this later when we see the other results.

### Would it be ideal and possible for those with teaching duties to work proportionally more from home in the future than before the pandemic?

Would it be possible?

```{r}
processed %>% 
  filter(edu_duties == "Yes") %>% 
  count(feasible) %>% 
  mutate(N = sum(n),
         prop = round(n / N * 100, 2))
```

Would it be ideal?

```{r}
processed %>% 
  filter(edu_duties == "Yes") %>% 
  mutate(more_from_home = case_when(future_prior_diff > 0 ~ "Respondent wants to work more from home",
                                    future_prior_diff < 0 ~ "Respondent wants to work less from home",
                                    future_prior_diff == 0 ~ "Respondent working the ideal amount of time from home")) %>% 
  count(more_from_home) %>%
  mutate(N = sum(n),
         prop = n / N * 100)
```

